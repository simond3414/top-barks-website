---
export const prerender = false;
---
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reviews Dashboard | Top Barks</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; min-height: 100vh; }
    .header { background: #3d6b3d; color: white; padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; }
    .header h1 { font-size: 24px; font-family: 'Poppins', sans-serif; }
    .header button { background: rgba(255, 255, 255, 0.2); color: white; border: 1px solid white; padding: 8px 16px; border-radius: 6px; cursor: pointer; transition: all 0.3s; }
    .header button:hover { background: white; color: #3d6b3d; }
    .container { max-width: 1200px; margin: 0 auto; padding: 40px 20px; }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px; }
    .stat-card { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
    .stat-card h3 { color: #666; font-size: 14px; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-card .number { font-size: 32px; font-weight: bold; color: #3d6b3d; }
    .tabs { display: flex; gap: 4px; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0; }
    .tab { padding: 12px 24px; border: none; background: none; font-size: 14px; font-weight: 600; color: #666; cursor: pointer; transition: all 0.3s; border-bottom: 2px solid transparent; margin-bottom: -2px; }
    .tab:hover { color: #3d6b3d; }
    .tab.active { color: #3d6b3d; border-bottom-color: #3d6b3d; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .actions { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); margin-bottom: 40px; }
    .actions h2 { margin-bottom: 20px; color: #333; }
    .action-buttons { display: flex; gap: 12px; flex-wrap: wrap; }
    .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
    .btn-primary { background: #3d6b3d; color: white; }
    .btn-primary:hover { background: #2d5a2d; }
    .btn-secondary { background: #e0e0e0; color: #333; }
    .btn-secondary:hover { background: #d0d0d0; }
    .btn-warning { background: #f59e0b; color: white; }
    .btn-warning:hover { background: #d97706; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .reviews-section { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
    .reviews-section h2 { margin-bottom: 20px; color: #333; }
    .last-updated { color: #666; font-size: 14px; margin-bottom: 20px; }
    .review-card { border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 16px; transition: box-shadow 0.3s; }
    .review-card:hover { box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }
    .review-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px; }
    .review-meta { display: flex; align-items: center; gap: 12px; }
    .source-badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: uppercase; }
    .source-google { background: #e8f5e9; color: #3d6b3d; }
    .source-facebook { background: #e3f2fd; color: #1976d2; }
    .reviewer-name { font-weight: 600; color: #333; }
    .rating { color: #ffc107; font-size: 18px; }
    .review-date { color: #999; font-size: 12px; }
    .review-text { color: #555; line-height: 1.6; margin-bottom: 12px; }
    .review-actions { display: flex; gap: 8px; }
    .review-actions button { padding: 6px 12px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; font-size: 12px; transition: all 0.3s; }
    .review-actions button:hover { background: #f5f5f5; }
    .review-actions .delete-btn { color: #c33; border-color: #fcc; }
    .review-actions .delete-btn:hover { background: #fee; }
    .no-reviews { text-align: center; padding: 40px; color: #999; }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal-overlay.show { display: flex; }
    .modal { background: white; padding: 32px; border-radius: 16px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
    .modal h2 { margin-bottom: 24px; color: #333; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; color: #555; font-weight: 500; font-size: 14px; }
    .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; font-family: inherit; }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: #3d6b3d; }
    .form-group textarea { min-height: 100px; resize: vertical; }
    .modal-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; }
    .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid #fff; border-radius: 50%; border-top-color: transparent; animation: spin 1s ease-in-out infinite; vertical-align: middle; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .message { padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; display: none; }
    .message.show { display: block; }
    .message.success { background: #e8f5e9; color: #3d6b3d; border: 1px solid #c8e6c9; }
    .message.error { background: #fee; color: #c33; border: 1px solid #fcc; }
    .api-status { padding: 12px; border-radius: 6px; margin-top: 16px; font-size: 13px; }
    .api-status.ok { background: #e8f5e9; color: #3d6b3d; }
    .api-status.error { background: #fee; color: #c33; }
    .api-status.warning { background: #fef3c7; color: #92400e; }
    .resource-item { cursor: move; transition: all 0.2s; }
    .resource-item:hover { background: #f5f5f5; }
    .resource-item.drag-over { border: 2px dashed #3d6b3d; background: #f0f7f0; }
    .category-section { transition: all 0.3s; }
    .category-section:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    #dropZone { transition: all 0.3s; }
    #dropZone:hover { border-color: #3d6b3d; background: #f0f7f0; }
    
    /* Category Management Styles */
    .category-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: move;
      transition: all 0.2s;
    }
    .category-item:hover {
      background: #e8e8e8;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .category-item.dragging {
      opacity: 0.5;
      transform: scale(1.02);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .category-item.drag-over {
      border-top: 3px solid #3d6b3d;
      margin-top: 4px;
    }
    .category-item[data-category="Uncategorized"] {
      background: #fff3e0;
      border-color: #ffe0b2;
      cursor: default;
    }
    .category-item[data-category="Uncategorized"]:hover {
      background: #ffe0b2;
    }
    .drag-handle {
      cursor: grab;
      color: #999;
      font-size: 18px;
      margin-right: 12px;
      user-select: none;
    }
    .drag-handle:active {
      cursor: grabbing;
    }
    .category-name {
      flex: 1;
      font-weight: 500;
    }
    .category-actions {
      display: flex;
      gap: 8px;
    }
    .btn-icon {
      padding: 6px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      background: transparent;
      transition: all 0.2s;
    }
    .btn-rename {
      color: #3d6b3d;
    }
    .btn-rename:hover {
      background: #e8f5e9;
    }
    .btn-delete {
      color: #c33;
    }
    .btn-delete:hover {
      background: #fee;
    }
    .permanent-badge {
      font-size: 11px;
      color: #999;
      font-style: italic;
      margin-left: 8px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Top Barks - Admin Dashboard</h1>
    <button id="logoutBtn">Logout</button>
  </div>

  <div class="container">
    <div id="message" class="message"></div>

    <div class="tabs">
      <button class="tab active" data-tab="reviews">Reviews</button>
      <button class="tab" data-tab="resources">Resources</button>
    </div>

    <!-- Reviews Tab -->
    <div id="reviews-tab" class="tab-content active">
      <div class="stats">
        <div class="stat-card">
          <h3>Total Reviews</h3>
          <div class="number" id="totalCount">-</div>
        </div>
        <div class="stat-card">
          <h3>Google Reviews</h3>
          <div class="number" id="googleCount">-</div>
        </div>
        <div class="stat-card">
          <h3>Facebook Reviews</h3>
          <div class="number" id="facebookCount">-</div>
        </div>
        <div class="stat-card">
          <h3>Last Updated</h3>
          <div class="number" style="font-size: 14px;" id="lastUpdated">-</div>
        </div>
      </div>

      <div class="actions">
        <h2>Actions</h2>
        <div class="action-buttons">
          <button class="btn btn-primary" id="refreshBtn">
            <span id="refreshSpinner"></span>
            Refresh Google Reviews
          </button>
          <button class="btn btn-secondary" id="addReviewBtn">
            + Add Facebook Review
          </button>
          <button class="btn btn-warning" id="testApiBtn">
            Test API Key
          </button>
        </div>
        <div id="apiStatus" class="api-status" style="display: none;"></div>
      </div>

      <div class="reviews-section">
        <h2>All Reviews</h2>
        <div class="last-updated" id="lastUpdatedText">Loading...</div>
        <div id="reviewsList">
          <div class="no-reviews">Loading reviews...</div>
        </div>
      </div>
    </div>

    <!-- Resources Tab -->
    <div id="resources-tab" class="tab-content">
      <div class="stats">
        <div class="stat-card">
          <h3>Total Resources</h3>
          <div class="number" id="resourcesCount">-</div>
        </div>
        <div class="stat-card">
          <h3>Categories</h3>
          <div class="number" id="categoriesCount">-</div>
        </div>
        <div class="stat-card">
          <h3>Storage Used</h3>
          <div class="number" style="font-size: 24px;" id="storageUsed">6.3 MB</div>
        </div>
        <div class="stat-card">
          <h3>Last Sync</h3>
          <div class="number" style="font-size: 14px;" id="lastSync">-</div>
        </div>
      </div>

      <div class="actions">
        <h2>Actions</h2>
        <div class="action-buttons">
          <button class="btn btn-primary" id="refreshResourcesBtn">
            <span id="resourcesSpinner"></span>
            Refresh Resources List
          </button>
          <button class="btn btn-secondary" id="uploadResourceBtn">
            + Upload New Resource
          </button>
          <button class="btn btn-secondary" id="manageCategoriesBtn">
            Manage Categories
          </button>
        </div>
        <div id="resourcesStatus" class="api-status" style="display: none;"></div>
      </div>

      <!-- Upload Area (hidden by default) -->
      <div id="uploadArea" class="actions" style="display: none;">
        <h3>Upload New Resource</h3>
        <div id="dropZone" style="border: 2px dashed #ccc; border-radius: 8px; padding: 40px; text-align: center; background: #f9f9f9; margin: 16px 0;">
          <p style="margin: 0; color: #666;">Drag & drop PDF files here or click to browse</p>
          <input type="file" id="fileInput" accept=".pdf" multiple style="display: none;">
          <button class="btn btn-secondary" style="margin-top: 12px;" onclick="document.getElementById('fileInput').click()">Browse Files</button>
        </div>
        <div id="uploadPreview" style="display: none;">
          <div id="uploadFilesList" style="margin: 16px 0;"></div>
          <div style="display: flex; gap: 12px; margin-top: 16px;">
            <button class="btn btn-secondary" id="cancelUploadBtn">Cancel</button>
            <button class="btn btn-primary" id="confirmUploadBtn">Upload Files</button>
          </div>
        </div>
      </div>

      <div class="reviews-section">
        <h2>Client Resources</h2>
        <div class="last-updated" id="resourcesLastUpdated">Loading resources...</div>
        <div id="resourcesList">
          <div class="no-reviews">Loading resources...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Category Management Modal -->
  <div class="modal-overlay" id="categoryModal">
    <div class="modal" style="max-width: 500px;">
      <h2>Manage Categories</h2>
      <p style="color: #666; font-size: 13px; margin-bottom: 16px;">
        <span style="font-weight: 600;">⋮⋮</span> Drag to reorder categories
      </p>
      <div id="categoryList" style="margin: 20px 0; max-height: 400px; overflow-y: auto;"></div>
      <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
        <h3>Add New Category</h3>
        <div style="display: flex; gap: 8px; margin-top: 8px;">
          <input type="text" id="newCategoryInput" placeholder="Category name" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          <button class="btn btn-primary" id="addCategoryBtn">Add</button>
        </div>
      </div>
      <div class="modal-actions" style="margin-top: 24px;">
        <button type="button" class="btn btn-secondary" id="closeCategoryModal">Close</button>
      </div>
    </div>
  </div>

  <!-- Delete Category Confirmation Modal -->
  <div class="modal-overlay" id="deleteCategoryModal">
    <div class="modal" style="max-width: 400px;">
      <h2>Delete Category</h2>
      <p style="margin-bottom: 12px;">
        Delete "<span id="deleteCategoryName" style="font-weight: 600;"></span>"?
      </p>
      <p id="deleteCategoryFileCount" style="color: #666; font-size: 14px; margin-bottom: 16px;">
        This category contains <span id="fileCountDisplay" style="font-weight: 600;"></span> files.
      </p>
      <div style="background: #e8f5e9; padding: 12px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #3d6b3d;">
        <p style="margin: 0; font-size: 14px;">
          <strong>Files will be moved to:</strong> Uncategorized
        </p>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" id="cancelDeleteCategory">Cancel</button>
        <button type="button" class="btn btn-warning" id="confirmDeleteCategory">Delete Category</button>
      </div>
    </div>
  </div>

  <!-- Edit Resource Modal -->
  <div class="modal-overlay" id="editResourceModal">
    <div class="modal">
      <h2>Edit Resource</h2>
      <input type="hidden" id="editResourceFilename">
      <div style="margin-bottom: 16px;">
        <label style="display: block; margin-bottom: 4px; font-weight: 500;">Display Name</label>
        <input type="text" id="editResourceDisplayName" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
      </div>
      <div style="margin-bottom: 16px;">
        <label style="display: block; margin-bottom: 4px; font-weight: 500;">Category</label>
        <select id="editResourceCategory" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></select>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" id="cancelEditResource">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveEditResource">Save Changes</button>
      </div>
    </div>
  </div>
  
  <div class="modal-overlay" id="modal">
    <div class="modal">
      <h2 id="modalTitle">Add Facebook Review</h2>
      <form id="reviewForm">
        <input type="hidden" id="reviewId">
        <div class="form-group">
          <label for="author">Reviewer Name *</label>
          <input type="text" id="author" required placeholder="e.g., Sarah Johnson">
        </div>
        <div class="form-group">
          <label for="rating">Rating (optional - leave empty for recommendation)</label>
          <select id="rating">
            <option value="">-- No star rating (Recommendation) --</option>
            <option value="5">★★★★★ (5 stars)</option>
            <option value="4">★★★★☆ (4 stars)</option>
            <option value="3">★★★☆☆ (3 stars)</option>
            <option value="2">★★☆☆☆ (2 stars)</option>
            <option value="1">★☆☆☆☆ (1 star)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="isRecommendation">
            <input type="checkbox" id="isRecommendation" checked style="width: auto; margin-right: 8px;">
            Mark as Recommendation (no star rating)
          </label>
        </div>
        <div class="form-group">
          <label for="reviewText">Review Text *</label>
          <textarea id="reviewText" required placeholder="Enter the review text..."></textarea>
        </div>
        <div class="form-group">
          <label for="reviewDate">Date *</label>
          <input type="date" id="reviewDate" required>
        </div>
        <div class="form-group">
          <label for="reviewUrl">Facebook Post URL or Embed Code</label>
          <textarea id="reviewUrl" placeholder="Paste the Facebook post URL or the full iframe embed code here..." rows="3"></textarea>
          <small style="color: #666; font-size: 12px; display: block; margin-top: 4px;">
            Tip: You can paste the full iframe embed code - the URL will be extracted automatically
          </small>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
          <button type="submit" class="btn btn-primary" id="saveBtn">Save Review</button>
        </div>
      </form>
    </div>
  </div>

  <script is:inline>
    // Check authentication
    if (!document.cookie.includes('admin_session=authenticated')) {
      window.location.href = '/admin';
    }
    
    /** @type {Array<any>} */
    let currentReviews = [];
    /** @type {string|null} */
    let editingId = null;
    
    // Load reviews on page load
    loadReviews();
    
    // Attach event listeners to main buttons
    document.getElementById('refreshBtn')?.addEventListener('click', refreshGoogleReviews);
    document.getElementById('addReviewBtn')?.addEventListener('click', openAddModal);
    document.getElementById('cancelBtn')?.addEventListener('click', closeModal);
    document.getElementById('logoutBtn')?.addEventListener('click', logout);
    document.getElementById('testApiBtn')?.addEventListener('click', testApiKey);

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.getAttribute('data-tab');
        switchTab(tabName || '');
      });
    });
    
    // Close modal on overlay click
    const modal = document.getElementById('modal');
    if (modal) {
      modal.addEventListener('click', function(/** @type {MouseEvent} */ e) {
        /** @type {HTMLElement} */
        const target = e.target;
        if (target.id === 'modal') {
          closeModal();
        }
      });
    }
    
    // Handle form submission
    const reviewForm = document.getElementById('reviewForm');
    if (reviewForm) {
      reviewForm.addEventListener('submit', async function(/** @type {Event} */ e) {
        e.preventDefault();
        
        /** @type {HTMLButtonElement|null} */
        const saveBtn = document.getElementById('saveBtn');
        /** @type {HTMLInputElement|null} */
        const authorInput = document.getElementById('author');
        /** @type {HTMLSelectElement|null} */
        const ratingSelect = document.getElementById('rating');
        /** @type {HTMLTextAreaElement|null} */
        const reviewTextArea = document.getElementById('reviewText');
        /** @type {HTMLInputElement|null} */
        const reviewDateInput = document.getElementById('reviewDate');
        /** @type {HTMLTextAreaElement|null} */
        const reviewUrlInput = document.getElementById('reviewUrl');
        /** @type {HTMLInputElement|null} */
        const isRecommendationInput = document.getElementById('isRecommendation');
        
        if (!authorInput || !reviewTextArea || !reviewDateInput) {
          showMessage('Missing required fields (author, text, and date are required)', 'error');
          return;
        }
        
        if (saveBtn) {
          saveBtn.disabled = true;
          saveBtn.textContent = 'Saving...';
        }
        
        // Build review data
        const reviewData = {
          action: editingId ? null : 'add_facebook',
          id: editingId,
          author: authorInput.value,
          text: reviewTextArea.value,
          date: reviewDateInput.value,
          url: reviewUrlInput?.value || '',
          isRecommendation: isRecommendationInput?.checked ?? true
        };
        
        // Only add rating if provided
        if (ratingSelect && ratingSelect.value) {
          reviewData.rating = parseInt(ratingSelect.value);
        }
        
        try {
          const method = editingId ? 'PUT' : 'POST';
          const response = await fetch('/api/reviews', {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(reviewData)
          });
          
          const data = await response.json();
          
          if (data.success) {
            showMessage(editingId ? 'Review updated' : 'Review added', 'success');
            closeModal();
            await loadReviews();
          } else {
            showMessage(data.message || 'Error saving review', 'error');
          }
        } catch (/** @type {any} */ error) {
          console.error('Error saving review:', error);
          showMessage('Error saving review: ' + error.message, 'error');
        } finally {
          if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save Review';
          }
        }
      });
    }
    
    async function loadReviews() {
      try {
        const response = await fetch('/api/reviews');
        const data = await response.json();
        
        if (data.reviews) {
          currentReviews = data.reviews;
          displayReviews(data.reviews);
          updateStats(data);
        }
      } catch (/** @type {any} */ error) {
        console.error('Error loading reviews:', error);
        showMessage('Error loading reviews: ' + error.message, 'error');
      }
    }
    
    /**
     * @param {Array<any>} reviews
     */
    function displayReviews(reviews) {
      /** @type {HTMLElement|null} */
      const container = document.getElementById('reviewsList');
      if (!container) return;
      
      if (reviews.length === 0) {
        container.innerHTML = '<div class="no-reviews">No reviews yet. Click "Refresh Google Reviews" to fetch reviews, or "Test API Key" to check if your API is configured.</div>';
        return;
      }
      
      container.innerHTML = reviews.map(review => {
        const fullText = review.text || '';
        const isLong = fullText.length > 200;
        const displayText = isLong ? fullText.substring(0, 200) + '...' : fullText;
        
        // Handle rating display - show stars if rated, "Recommended" badge if not
        let ratingDisplay = '';
        if (review.rating) {
          ratingDisplay = `<span class="rating">${'★'.repeat(review.rating)}${'☆'.repeat(5 - review.rating)}</span>`;
        } else if (review.source === 'facebook') {
          ratingDisplay = `<span class="source-badge source-facebook" style="background: #e8f5e9; color: #2e7d32;">✓ Recommended</span>`;
        }
        
        // Handle URL display
        let urlDisplay = '';
        if (review.url) {
          urlDisplay = `<a href="${escapeHtml(review.url)}" target="_blank" style="font-size: 12px; color: #3d6b3d; display: block; margin-top: 8px;">View Original →</a>`;
        } else if (review.source === 'facebook') {
          urlDisplay = `<span style="font-size: 12px; color: #999; display: block; margin-top: 8px;">No link available</span>`;
        }
        
        return `
          <div class="review-card" data-review-id="${review.id}" data-review-source="${review.source}">
            <div class="review-header">
              <div class="review-meta">
                <span class="source-badge source-${review.source}">${review.source}</span>
                <span class="reviewer-name">${escapeHtml(review.author)}</span>
                ${ratingDisplay}
              </div>
              <span class="review-date">${formatDate(review.date)}</span>
            </div>
            <div class="review-text">${escapeHtml(displayText)}${isLong ? '...' : ''}</div>
            ${urlDisplay}
            ${review.source === 'facebook' ? `
              <div class="review-actions">
                <button class="edit-btn" data-action="edit">Edit</button>
                <button class="delete-btn" data-action="delete">Delete</button>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
      
      attachReviewActionListeners(container);
    }
    
    /**
     * @param {HTMLElement} container
     */
    function attachReviewActionListeners(container) {
      container.addEventListener('click', function(/** @type {MouseEvent} */ e) {
        /** @type {HTMLElement} */
        const target = e.target;
        /** @type {HTMLElement|null} */
        const reviewCard = target.closest('.review-card');
        
        if (!reviewCard) return;
        
        const reviewId = reviewCard.getAttribute('data-review-id');
        if (!reviewId) return;
        
        if (target.classList.contains('edit-btn') || target.getAttribute('data-action') === 'edit') {
          e.preventDefault();
          editReview(reviewId);
        } else if (target.classList.contains('delete-btn') || target.getAttribute('data-action') === 'delete') {
          e.preventDefault();
          deleteReview(reviewId);
        }
      });
    }
    
    /**
     * @param {any} data
     */
    function updateStats(data) {
      const totalCountEl = document.getElementById('totalCount');
      const googleCountEl = document.getElementById('googleCount');
      const facebookCountEl = document.getElementById('facebookCount');
      const lastUpdatedEl = document.getElementById('lastUpdated');
      const lastUpdatedTextEl = document.getElementById('lastUpdatedText');
      
      if (totalCountEl) totalCountEl.textContent = data.reviews?.length || 0;
      if (googleCountEl) googleCountEl.textContent = data.googleCount || 0;
      if (facebookCountEl) facebookCountEl.textContent = data.facebookCount || 0;
      
      if (data.lastUpdated && lastUpdatedEl) {
        const date = new Date(data.lastUpdated);
        lastUpdatedEl.textContent = date.toLocaleDateString('en-GB');
        if (lastUpdatedTextEl) {
          lastUpdatedTextEl.textContent = `Last updated: ${date.toLocaleString('en-GB')}`;
        }
      } else if (lastUpdatedTextEl) {
        lastUpdatedTextEl.textContent = 'Never updated';
      }
    }
    
    async function refreshGoogleReviews() {
      /** @type {HTMLButtonElement|null} */
      const btn = document.getElementById('refreshBtn');
      const spinner = document.getElementById('refreshSpinner');
      
      if (btn) btn.disabled = true;
      if (spinner) spinner.className = 'loading';
      
      try {
        console.log('Fetching Google reviews...');
        const response = await fetch('/api/reviews', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'refresh_google' })
        });
        
        console.log('Response status:', response.status);
        const data = await response.json();
        console.log('Response data:', data);
        
        if (data.success) {
          showMessage(`Successfully refreshed ${data.count} Google reviews`, 'success');
          await loadReviews();
        } else {
          showMessage(data.message || 'Error refreshing reviews', 'error');
        }
      } catch (/** @type {any} */ error) {
        console.error('Error refreshing reviews:', error);
        showMessage('Error refreshing reviews: ' + error.message + '. Make sure API key is configured.', 'error');
      } finally {
        if (btn) btn.disabled = false;
        if (spinner) spinner.className = '';
      }
    }
    
    async function testApiKey() {
      /** @type {HTMLButtonElement|null} */
      const btn = document.getElementById('testApiBtn');
      /** @type {HTMLElement|null} */
      const statusDiv = document.getElementById('apiStatus');
      
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'Testing...';
      }
      
      if (statusDiv) {
        statusDiv.style.display = 'block';
        statusDiv.className = 'api-status';
        statusDiv.textContent = 'Testing API key...';
      }
      
      try {
        console.log('Testing API key...');
        const response = await fetch('/api/reviews', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'test_api' })
        });
        
        const data = await response.json();
        console.log('API test response:', data);
        
        if (statusDiv) {
          if (data.success && data.apiConfigured) {
            statusDiv.className = 'api-status ok';
            statusDiv.innerHTML = `✓ API key is configured and working<br>Fetched ${data.count || 0} reviews`;
            showMessage('API key is working!', 'success');
          } else if (data.success && !data.apiConfigured) {
            statusDiv.className = 'api-status error';
            statusDiv.innerHTML = '✗ API key is not configured<br>Please set GOOGLE_PLACES_API_KEY in Cloudflare Dashboard → Pages → Environment Variables';
            showMessage('API key not configured', 'error');
          } else {
            statusDiv.className = 'api-status error';
            statusDiv.textContent = '✗ API test failed: ' + (data.message || 'Unknown error');
            showMessage('API test failed: ' + (data.message || 'Unknown error'), 'error');
          }
        }
      } catch (/** @type {any} */ error) {
        console.error('Error testing API:', error);
        if (statusDiv) {
          statusDiv.className = 'api-status error';
          statusDiv.textContent = '✗ Error testing API: ' + error.message;
        }
        showMessage('Error testing API: ' + error.message, 'error');
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'Test API Key';
        }
      }
    }
    
    function openAddModal() {
      editingId = null;
      /** @type {HTMLElement|null} */
      const modalTitle = document.getElementById('modalTitle');
      /** @type {HTMLElement|null} */
      const modal = document.getElementById('modal');
      /** @type {HTMLFormElement|null} */
      const reviewForm = document.getElementById('reviewForm');
      /** @type {HTMLInputElement|null} */
      const reviewDate = document.getElementById('reviewDate');
      /** @type {HTMLInputElement|null} */
      const isRecommendationInput = document.getElementById('isRecommendation');
      /** @type {HTMLSelectElement|null} */
      const ratingSelect = document.getElementById('rating');
      
      if (modalTitle) modalTitle.textContent = 'Add Facebook Review';
      if (reviewForm) reviewForm.reset();
      if (reviewDate) reviewDate.value = new Date().toISOString().split('T')[0];
      
      // Set defaults for new review
      if (isRecommendationInput) isRecommendationInput.checked = true;
      if (ratingSelect) ratingSelect.value = ''; // No rating by default
      
      if (modal) modal.classList.add('show');
    }
    
    /**
     * @param {string} id
     */
    function editReview(id) {
      const review = currentReviews.find(r => r.id === id);
      if (!review) return;
      
      editingId = id;
      /** @type {HTMLElement|null} */
      const modalTitle = document.getElementById('modalTitle');
      /** @type {HTMLElement|null} */
      const modal = document.getElementById('modal');
      /** @type {HTMLInputElement|null} */
      const reviewIdInput = document.getElementById('reviewId');
      /** @type {HTMLInputElement|null} */
      const authorInput = document.getElementById('author');
      /** @type {HTMLSelectElement|null} */
      const ratingSelect = document.getElementById('rating');
      /** @type {HTMLTextAreaElement|null} */
      const reviewTextArea = document.getElementById('reviewText');
      /** @type {HTMLInputElement|null} */
      const reviewDateInput = document.getElementById('reviewDate');
      /** @type {HTMLTextAreaElement|null} */
      const reviewUrlInput = document.getElementById('reviewUrl');
      /** @type {HTMLInputElement|null} */
      const isRecommendationInput = document.getElementById('isRecommendation');
      
      if (modalTitle) modalTitle.textContent = 'Edit Facebook Review';
      if (reviewIdInput) reviewIdInput.value = id;
      if (authorInput) authorInput.value = review.author;
      if (reviewTextArea) reviewTextArea.value = review.text;
      if (reviewDateInput) reviewDateInput.value = review.date.split('T')[0];
      if (reviewUrlInput) reviewUrlInput.value = review.url || '';
      
      // Handle rating - if no rating, select the "no rating" option and check recommendation
      if (ratingSelect) {
        if (review.rating) {
          ratingSelect.value = String(review.rating);
        } else {
          ratingSelect.value = '';
        }
      }
      
      // Set recommendation checkbox - default to true if no rating
      if (isRecommendationInput) {
        isRecommendationInput.checked = review.isRecommendation !== false && !review.rating;
      }
      
      if (modal) modal.classList.add('show');
    }
    
    function closeModal() {
      const modal = document.getElementById('modal');
      if (modal) modal.classList.remove('show');
    }
    
    /**
     * @param {string} id
     */
    async function deleteReview(id) {
      if (!confirm('Are you sure you want to delete this review?')) return;
      
      try {
        const response = await fetch('/api/reviews', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id })
        });
        
        const data = await response.json();
        
        if (data.success) {
          showMessage('Review deleted', 'success');
          await loadReviews();
        } else {
          showMessage(data.message || 'Error deleting review', 'error');
        }
      } catch (/** @type {any} */ error) {
        console.error('Error deleting review:', error);
        showMessage('Error deleting review: ' + error.message, 'error');
      }
    }
    
    // Tab switching
    /**
     * @param {string} tabName
     */
    function switchTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.getAttribute('data-tab') === tabName) {
          tab.classList.add('active');
        }
      });

      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      const contentElement = document.getElementById(tabName + '-tab');
      if (contentElement) {
        contentElement.classList.add('active');
      }

      // Load resources if switching to resources tab
      if (tabName === 'resources') {
        loadResources();
      }
    }

    // Resources management
    let currentResources = [];
    let currentCategories = [];
    let selectedFiles = [];
    let dragSrcEl = null;

    async function loadResources() {
      const statusDiv = document.getElementById('resourcesStatus');
      const listDiv = document.getElementById('resourcesList');
      const lastUpdatedDiv = document.getElementById('resourcesLastUpdated');
      const categoriesCountEl = document.getElementById('categoriesCount');

      if (statusDiv) {
        statusDiv.style.display = 'block';
        statusDiv.className = 'api-status';
        statusDiv.textContent = 'Loading resources...';
      }

      try {
        const response = await fetch('/api/resources');
        const data = await response.json();

        if (data.success) {
          currentResources = data.files;
          currentCategories = data.categories || [];
          
          // Update categories count
          if (categoriesCountEl) {
            categoriesCountEl.textContent = currentCategories.length;
          }
          
          displayResources(data.byCategory);

          // Update stats
          const resourcesCountEl = document.getElementById('resourcesCount');
          if (resourcesCountEl) {
            resourcesCountEl.textContent = data.total || 0;
          }

          const lastSyncEl = document.getElementById('lastSync');
          if (lastSyncEl) {
            lastSyncEl.textContent = new Date().toLocaleString('en-GB');
          }

          if (lastUpdatedDiv) {
            lastUpdatedDiv.textContent = `Last synced: ${new Date().toLocaleString('en-GB')}`;
          }

          if (statusDiv) {
            statusDiv.className = 'api-status ok';
            statusDiv.innerHTML = '✓ Resources loaded successfully';
          }
        } else {
          if (statusDiv) {
            statusDiv.className = 'api-status error';
            statusDiv.textContent = '✗ Error: ' + (data.message || 'Failed to load resources');
          }
          if (listDiv) {
            listDiv.innerHTML = '<div class="no-reviews">Error loading resources. Please check R2 bucket configuration.</div>';
          }
        }
      } catch (error) {
        console.error('Error loading resources:', error);
        if (statusDiv) {
          statusDiv.className = 'api-status error';
          statusDiv.textContent = '✗ Error: ' + error.message;
        }
        if (listDiv) {
          listDiv.innerHTML = '<div class="no-reviews">Error loading resources. Make sure TOPBARKS_RESOURCES R2 bucket is configured.</div>';
        }
      }
    }

    /**
     * @param {Record<string, any>} byCategory
     */
    function displayResources(byCategory) {
      const container = document.getElementById('resourcesList');
      if (!container) return;

      if (!byCategory || Object.keys(byCategory).length === 0) {
        container.innerHTML = '<div class="no-reviews">No resources found. Click "Upload New Resource" to add files.</div>';
        return;
      }

      let html = '';

      for (const [category, files] of Object.entries(byCategory)) {
        html += `
          <div class="category-section" data-category="${escapeHtml(category)}" style="margin-bottom: 32px; background: #f9f9f9; border-radius: 8px; padding: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #3d6b3d;">
              <h3 style="color: #3d6b3d; margin: 0;">${escapeHtml(category)}</h3>
              <div style="display: flex; gap: 8px;">
                <button class="btn btn-secondary" style="padding: 4px 12px; font-size: 12px;" onclick="renameCategory('${escapeHtml(category)}')">Rename</button>
              </div>
            </div>
            <div class="resource-list" style="display: grid; gap: 12px;" data-category="${escapeHtml(category)}">
        `;

        for (const file of files) {
          html += `
            <div class="resource-item review-card" draggable="true" data-filename="${escapeHtml(file.filename)}" style="display: flex; justify-content: space-between; align-items: center; cursor: move;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <span style="color: #999; cursor: move;">⋮⋮</span>
                <div>
                  <div style="font-weight: 600; color: #333; margin-bottom: 4px;">${escapeHtml(file.displayName)}</div>
                  <div style="font-size: 12px; color: #666;">${escapeHtml(file.filename)} • ${escapeHtml(file.size || 'Unknown')}</div>
                </div>
              </div>
              <div style="display: flex; gap: 8px;">
                <button class="btn btn-secondary" style="padding: 4px 12px; font-size: 12px;" onclick="editResource('${escapeHtml(file.filename)}')">Edit</button>
                <button class="btn btn-warning delete-btn" style="padding: 4px 12px; font-size: 12px;" onclick="deleteResource('${escapeHtml(file.filename)}')">Delete</button>
                <a href="/api/resources?file=${encodeURIComponent(file.filename)}" target="_blank" class="btn btn-primary" style="text-decoration: none; padding: 4px 12px; font-size: 12px;">Download</a>
              </div>
            </div>
          `;
        }

        html += '</div></div>';
      }

      container.innerHTML = html;
      
      // Add drag and drop event listeners
      setupDragAndDrop();
    }

    function setupDragAndDrop() {
      const items = document.querySelectorAll('.resource-item');
      items.forEach(item => {
        item.addEventListener('dragstart', handleDragStart);
        item.addEventListener('dragend', handleDragEnd);
        item.addEventListener('dragover', handleDragOver);
        item.addEventListener('dragenter', handleDragEnter);
        item.addEventListener('dragleave', handleDragLeave);
        item.addEventListener('drop', handleDrop);
      });
    }

    function handleDragStart(e) {
      dragSrcEl = this;
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', this.innerHTML);
      this.style.opacity = '0.4';
    }

    function handleDragEnd(e) {
      this.style.opacity = '1';
      const items = document.querySelectorAll('.resource-item');
      items.forEach(item => item.classList.remove('drag-over'));
    }

    function handleDragOver(e) {
      if (e.preventDefault) e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      return false;
    }

    function handleDragEnter(e) {
      this.classList.add('drag-over');
    }

    function handleDragLeave(e) {
      this.classList.remove('drag-over');
    }

    async function handleDrop(e) {
      if (e.stopPropagation) e.stopPropagation();
      
      if (dragSrcEl !== this) {
        const category = this.closest('.resource-list')?.getAttribute('data-category');
        const newOrder = Array.from(this.closest('.resource-list')?.children || [])
          .map((child, index) => ({
            filename: child.getAttribute('data-filename'),
            order: index
          }));
        
        // Save new order
        try {
          await fetch('/api/resources', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'reorder',
              category,
              files: newOrder.map(item => item.filename)
            })
          });
          showMessage('Order updated', 'success');
        } catch (error) {
          showMessage('Error updating order', 'error');
        }
        
        await loadResources();
      }
      
      return false;
    }

    document.getElementById('refreshResourcesBtn')?.addEventListener('click', async function() {
      const btn = document.getElementById('refreshResourcesBtn');
      const spinner = document.getElementById('resourcesSpinner');

      if (btn) btn.disabled = true;
      if (spinner) spinner.className = 'loading';

      await loadResources();

      if (btn) btn.disabled = false;
      if (spinner) spinner.className = '';
    });

    // Upload functionality
    document.getElementById('uploadResourceBtn')?.addEventListener('click', () => {
      const uploadArea = document.getElementById('uploadArea');
      if (uploadArea) {
        uploadArea.style.display = uploadArea.style.display === 'none' ? 'block' : 'none';
      }
    });

    document.getElementById('cancelUploadBtn')?.addEventListener('click', () => {
      const uploadArea = document.getElementById('uploadArea');
      const uploadPreview = document.getElementById('uploadPreview');
      const fileInput = document.getElementById('fileInput');
      
      if (uploadArea) uploadArea.style.display = 'none';
      if (uploadPreview) uploadPreview.style.display = 'none';
      if (fileInput) fileInput.value = '';
      selectedFiles = [];
    });

    // Drag and drop for upload
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');

    if (dropZone) {
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#3d6b3d';
        dropZone.style.background = '#f0f7f0';
      });

      dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#ccc';
        dropZone.style.background = '#f9f9f9';
      });

      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#ccc';
        dropZone.style.background = '#f9f9f9';
        
        const files = e.dataTransfer?.files;
        if (files) handleFiles(files);
      });

      dropZone.addEventListener('click', () => {
        fileInput?.click();
      });
    }

    if (fileInput) {
      fileInput.addEventListener('change', (e) => {
        const files = e.target?.files;
        if (files) handleFiles(files);
      });
    }

    /**
     * @param {FileList} files
     */
    function handleFiles(files) {
      selectedFiles = Array.from(files).filter(f => f.name.toLowerCase().endsWith('.pdf'));
      
      const uploadPreview = document.getElementById('uploadPreview');
      const uploadFilesList = document.getElementById('uploadFilesList');
      
      if (uploadFilesList) {
        let html = '<h4>Files to upload:</h4>';
        
        // Category selector
        html += '<div style="margin-bottom: 16px;"><label style="display: block; margin-bottom: 4px; font-weight: 500;">Select Category:</label>';
        html += '<select id="uploadCategory" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">';
        html += '<option value="">-- Select Category --</option>';
        currentCategories.forEach(cat => {
          html += `<option value="${escapeHtml(cat)}">${escapeHtml(cat)}</option>`;
        });
        html += '</select></div>';
        
        // Files list
        html += '<ul style="list-style: none; padding: 0; margin: 0;">';
        selectedFiles.forEach((file, index) => {
          html += `
            <li style="padding: 8px; background: #f5f5f5; border-radius: 4px; margin-bottom: 4px; display: flex; justify-content: space-between; align-items: center;">
              <span>${escapeHtml(file.name)} (${(file.size / 1024 / 1024).toFixed(2)} MB)</span>
              <button onclick="removeFile(${index})" style="background: none; border: none; color: #c33; cursor: pointer;">✕</button>
            </li>
          `;
        });
        html += '</ul>';
        
        uploadFilesList.innerHTML = html;
      }
      
      if (uploadPreview) uploadPreview.style.display = 'block';
    }

    window.removeFile = (index) => {
      selectedFiles.splice(index, 1);
      if (selectedFiles.length === 0) {
        const uploadPreview = document.getElementById('uploadPreview');
        if (uploadPreview) uploadPreview.style.display = 'none';
      } else {
        handleFiles(selectedFiles);
      }
    };

    document.getElementById('confirmUploadBtn')?.addEventListener('click', async () => {
      const categorySelect = document.getElementById('uploadCategory');
      const category = categorySelect?.value || 'Uncategorized';
      
      if (selectedFiles.length === 0) {
        showMessage('No files selected', 'error');
        return;
      }

      const btn = document.getElementById('confirmUploadBtn');
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'Uploading...';
      }

      try {
        for (const file of selectedFiles) {
          const formData = new FormData();
          formData.append('file', file);
          formData.append('category', category);
          formData.append('displayName', file.name.replace('.pdf', ''));

          const response = await fetch('/api/resources', {
            method: 'POST',
            body: formData
          });

          const data = await response.json();
          if (!data.success) {
            throw new Error(data.message || 'Upload failed');
          }
        }

        showMessage(`${selectedFiles.length} file(s) uploaded successfully`, 'success');
        
        // Reset upload area
        const uploadArea = document.getElementById('uploadArea');
        const uploadPreview = document.getElementById('uploadPreview');
        const fileInput = document.getElementById('fileInput');
        
        if (uploadArea) uploadArea.style.display = 'none';
        if (uploadPreview) uploadPreview.style.display = 'none';
        if (fileInput) fileInput.value = '';
        selectedFiles = [];
        
        await loadResources();
      } catch (error) {
        showMessage('Error uploading files: ' + error.message, 'error');
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'Upload Files';
        }
      }
    });

    // Category management
    document.getElementById('manageCategoriesBtn')?.addEventListener('click', () => {
      const modal = document.getElementById('categoryModal');
      displayCategories();
      if (modal) modal.classList.add('show');
    });

    // Display categories with drag-and-drop
    function displayCategories() {
      const listDiv = document.getElementById('categoryList');
      if (!listDiv) return;

      let html = '';
      currentCategories.forEach((cat, index) => {
        const isUncategorized = cat === 'Uncategorized';
        html += `
          <div class="category-item" 
               draggable="${!isUncategorized}" 
               data-category="${escapeHtml(cat)}"
               data-index="${index}">
            ${!isUncategorized ? '<span class="drag-handle">⋮⋮</span>' : '<span style="width: 30px;"></span>'}
            <span class="category-name">${escapeHtml(cat)}${isUncategorized ? '<span class="permanent-badge">(permanent)</span>' : ''}</span>
            <div class="category-actions">
              <button class="btn-icon btn-rename" title="Rename" onclick="renameCategoryPrompt('${escapeHtml(cat)}')">✎</button>
              ${!isUncategorized ? `<button class="btn-icon btn-delete" title="Delete category" onclick="deleteCategory('${escapeHtml(cat)}')">🗑️</button>` : ''}
            </div>
          </div>
        `;
      });
      listDiv.innerHTML = html;

      // Setup drag and drop
      setupCategoryDragAndDrop();
    }

    // Category drag and drop
    let dragSrcCategory = null;

    function setupCategoryDragAndDrop() {
      const items = document.querySelectorAll('.category-item[draggable="true"]');
      items.forEach(item => {
        item.addEventListener('dragstart', handleCategoryDragStart);
        item.addEventListener('dragend', handleCategoryDragEnd);
        item.addEventListener('dragover', handleCategoryDragOver);
        item.addEventListener('dragenter', handleCategoryDragEnter);
        item.addEventListener('dragleave', handleCategoryDragLeave);
        item.addEventListener('drop', handleCategoryDrop);
      });
    }

    function handleCategoryDragStart(e) {
      dragSrcCategory = this;
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', this.innerHTML);
    }

    function handleCategoryDragEnd(e) {
      this.classList.remove('dragging');
      const items = document.querySelectorAll('.category-item');
      items.forEach(item => item.classList.remove('drag-over'));
    }

    function handleCategoryDragOver(e) {
      if (e.preventDefault) e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      return false;
    }

    function handleCategoryDragEnter(e) {
      if (this !== dragSrcCategory) {
        this.classList.add('drag-over');
      }
    }

    function handleCategoryDragLeave(e) {
      this.classList.remove('drag-over');
    }

    async function handleCategoryDrop(e) {
      if (e.stopPropagation) e.stopPropagation();

      if (dragSrcCategory !== this) {
        // Get current order
        const listDiv = document.getElementById('categoryList');
        const items = Array.from(listDiv.querySelectorAll('.category-item'));
        
        // Swap positions visually
        const srcIndex = items.indexOf(dragSrcCategory);
        const targetIndex = items.indexOf(this);
        
        if (srcIndex < targetIndex) {
          this.parentNode.insertBefore(dragSrcCategory, this.nextSibling);
        } else {
          this.parentNode.insertBefore(dragSrcCategory, this);
        }

        // Get new order
        const newOrder = Array.from(listDiv.querySelectorAll('.category-item'))
          .map(item => item.getAttribute('data-category'));

        // Save to server
        try {
          const response = await fetch('/api/resources', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'reorder_categories',
              orderedCategories: newOrder
            })
          });

          const data = await response.json();
          if (data.success) {
            currentCategories = data.categories;
            showMessage('Categories reordered', 'success');
          } else {
            showMessage(data.message || 'Failed to reorder', 'error');
            displayCategories(); // Revert
          }
        } catch (error) {
          showMessage('Error saving order', 'error');
          displayCategories(); // Revert
        }
      }

      return false;
    }

    // Delete category
    window.deleteCategory = (categoryName) => {
      // Count files in this category
      const fileCount = currentResources.filter(r => r.category === categoryName).length;
      
      // Show modal
      document.getElementById('deleteCategoryName').textContent = categoryName;
      document.getElementById('fileCountDisplay').textContent = fileCount;
      document.getElementById('deleteCategoryModal').classList.add('show');
      
      // Store category being deleted
      window.categoryToDelete = categoryName;
    };

    // Cancel delete
    document.getElementById('cancelDeleteCategory')?.addEventListener('click', () => {
      document.getElementById('deleteCategoryModal').classList.remove('show');
      window.categoryToDelete = null;
    });

    // Confirm delete
    document.getElementById('confirmDeleteCategory')?.addEventListener('click', async () => {
      const category = window.categoryToDelete;
      if (!category) return;

      try {
        const response = await fetch('/api/resources', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'delete_category',
            category
          })
        });

        const data = await response.json();
        if (data.success) {
          showMessage('Category deleted. Files moved to Uncategorized.', 'success');
          currentCategories = data.categories;
          document.getElementById('deleteCategoryModal').classList.remove('show');
          window.categoryToDelete = null;
          await loadResources();
          displayCategories();
        } else {
          showMessage(data.message || 'Failed to delete category', 'error');
        }
      } catch (error) {
        showMessage('Error deleting category', 'error');
      }
    });

    // Close modals on overlay click
    document.getElementById('categoryModal')?.addEventListener('click', (e) => {
      if (e.target.id === 'categoryModal') {
        document.getElementById('categoryModal').classList.remove('show');
      }
    });

    document.getElementById('deleteCategoryModal')?.addEventListener('click', (e) => {
      if (e.target.id === 'deleteCategoryModal') {
        document.getElementById('deleteCategoryModal').classList.remove('show');
        window.categoryToDelete = null;
      }
    });

    document.getElementById('closeCategoryModal')?.addEventListener('click', () => {
      const modal = document.getElementById('categoryModal');
      if (modal) modal.classList.remove('show');
    });

    document.getElementById('addCategoryBtn')?.addEventListener('click', async () => {
      const input = document.getElementById('newCategoryInput');
      const category = input?.value?.trim();
      
      if (!category) {
        showMessage('Please enter a category name', 'error');
        return;
      }

      try {
        const response = await fetch('/api/resources', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'create_category', category })
        });

        const data = await response.json();
        if (data.success) {
          showMessage('Category created', 'success');
          input.value = '';
          currentCategories = data.categories;
          document.getElementById('manageCategoriesBtn')?.click();
        } else {
          showMessage(data.message || 'Failed to create category', 'error');
        }
      } catch (error) {
        showMessage('Error creating category', 'error');
      }
    });

    window.renameCategoryPrompt = async (oldName) => {
      const newName = prompt('Enter new category name:', oldName);
      if (!newName || newName === oldName) return;

      try {
        const response = await fetch('/api/resources', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'rename_category', oldName, newName })
        });

        const data = await response.json();
        if (data.success) {
          showMessage('Category renamed', 'success');
          currentCategories = data.categories;
          await loadResources();
          document.getElementById('manageCategoriesBtn')?.click();
        } else {
          showMessage(data.message || 'Failed to rename category', 'error');
        }
      } catch (error) {
        showMessage('Error renaming category', 'error');
      }
    };

    window.renameCategory = (oldName) => {
      renameCategoryPrompt(oldName);
    };

    window.editResource = (filename) => {
      const file = currentResources.find(r => r.filename === filename);
      if (!file) return;

      document.getElementById('editResourceFilename').value = filename;
      document.getElementById('editResourceDisplayName').value = file.displayName;
      
      const categorySelect = document.getElementById('editResourceCategory');
      categorySelect.innerHTML = currentCategories.map(cat => 
        `<option value="${escapeHtml(cat)}" ${cat === file.category ? 'selected' : ''}>${escapeHtml(cat)}</option>`
      ).join('');
      
      const modal = document.getElementById('editResourceModal');
      if (modal) modal.classList.add('show');
    };

    document.getElementById('cancelEditResource')?.addEventListener('click', () => {
      const modal = document.getElementById('editResourceModal');
      if (modal) modal.classList.remove('show');
    });

    document.getElementById('saveEditResource')?.addEventListener('click', async () => {
      const filename = document.getElementById('editResourceFilename').value;
      const displayName = document.getElementById('editResourceDisplayName').value;
      const category = document.getElementById('editResourceCategory').value;

      try {
        const response = await fetch('/api/resources', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'update_file',
            filename,
            displayName,
            category
          })
        });

        const data = await response.json();
        if (data.success) {
          showMessage('Resource updated', 'success');
          document.getElementById('editResourceModal').classList.remove('show');
          await loadResources();
        } else {
          showMessage(data.message || 'Failed to update', 'error');
        }
      } catch (error) {
        showMessage('Error updating resource', 'error');
      }
    });

    window.deleteResource = async (filename) => {
      if (!confirm(`Are you sure you want to delete "${filename}"?\n\nThis cannot be undone.`)) return;

      try {
        const response = await fetch('/api/resources', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ filename })
        });

        const data = await response.json();
        if (data.success) {
          showMessage('Resource deleted', 'success');
          await loadResources();
        } else {
          showMessage(data.message || 'Failed to delete', 'error');
        }
      } catch (error) {
        showMessage('Error deleting resource', 'error');
      }
    };

    /**
     * @param {string} text
     * @param {string} type
     */
    function showMessage(text, type) {
      const msg = document.getElementById('message');
      if (!msg) return;

      msg.textContent = text;
      msg.className = `message ${type} show`;

      setTimeout(function() {
        msg.classList.remove('show');
      }, 5000);
    }

    function logout() {
      document.cookie = 'admin_session=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
      window.location.href = '/admin';
    }

    /**
     * @param {string} text
     * @returns {string}
     */
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    /**
     * @param {string} dateString
     * @returns {string}
     */
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('en-GB', {
        day: 'numeric',
        month: 'short',
        year: 'numeric'
      });
    }
  </script>
</body>
</html>
